<!doctype html><!-- This site was created with Wowchemy. https://www.wowchemy.com --><!-- Last Published: January 9, 2025 --><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Wowchemy 5.7.0 for Hugo"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload as=style href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media=print onload='this.media="all"'><link rel=stylesheet href=/css/vendor-bundle.min.047268c6dd09ad74ba54a0ba71837064.css media=print onload='this.media="all"'><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/academicons@1.9.2/css/academicons.min.css integrity="sha512-KlJCpRsLf+KKu2VQa5vmRuClRFjxc5lXO03ixZt82HZUk41+1I0bD8KBSA0fY290ayMfWYI9udIqeOWSu1/uZg==" crossorigin=anonymous media=print onload='this.media="all"'><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/instantsearch.css@7.4.5/themes/satellite-min.css integrity="sha256-TehzF/2QvNKhGQrrNpoOb2Ck4iGZ1J/DI4pkd2oUsBc=" crossorigin=anonymous><link rel=stylesheet href=/css/wowchemy.042e26407c9e383d96a1f26d6787c686.css><link rel=stylesheet href=/css/libs/chroma/github-light.min.css title=hl-light media=print onload='this.media="all"'><link rel=stylesheet href=/css/libs/chroma/dracula.min.css title=hl-dark media=print onload='this.media="all"' disabled><meta name=author content="Denis Trofimov"><meta name=description content="
  
    This post describes how dictionaries are implemented in the Python language.
  
  
    This article is actually a repost of originally posted at Laurent Luce&#8217;s Blog August 29, 2011 by Laurent Luce. I mentor several students of russian Learn Python courses. They have questions about structures in Python and how to use them. I found this post a good help to me and possibly to my students.
  
"><link rel=alternate hreflang=en-us href=https://denis-trofimov.github.io/how-dictionaries-are-implemented-in-the-python-language/><link rel=canonical href=https://denis-trofimov.github.io/how-dictionaries-are-implemented-in-the-python-language/><link rel=manifest href=/manifest.webmanifest><link rel=icon type=image/png href=/media/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_32x32_fill_lanczos_center_3.png><link rel=apple-touch-icon type=image/png href=/media/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_180x180_fill_lanczos_center_3.png><meta name=theme-color content="#1565c0"><meta property="twitter:card" content="summary_large_image"><meta property="twitter:site" content="@deniscloudgeek"><meta property="twitter:creator" content="@deniscloudgeek"><meta property="twitter:image" content="https://denis-trofimov.github.io/how-dictionaries-are-implemented-in-the-python-language/featured.png"><meta property="og:site_name" content="Denis Trofimov Blog"><meta property="og:url" content="https://denis-trofimov.github.io/how-dictionaries-are-implemented-in-the-python-language/"><meta property="og:title" content="How dictionaries are implemented in the Python language | Denis Trofimov Blog"><meta property="og:description" content="
  
    This post describes how dictionaries are implemented in the Python language.
  
  
    This article is actually a repost of originally posted at Laurent Luce&#8217;s Blog August 29, 2011 by Laurent Luce. I mentor several students of russian Learn Python courses. They have questions about structures in Python and how to use them. I found this post a good help to me and possibly to my students.
  
"><meta property="og:image" content="https://denis-trofimov.github.io/how-dictionaries-are-implemented-in-the-python-language/featured.png"><meta property="og:locale" content="en-us"><meta property="article:published_time" content="2018-09-28T19:12:58+00:00"><meta property="article:modified_time" content="2018-09-28T19:12:58+00:00"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://denis-trofimov.github.io/how-dictionaries-are-implemented-in-the-python-language/"},"headline":"How dictionaries are implemented in the Python language","image":["https://denis-trofimov.github.io/how-dictionaries-are-implemented-in-the-python-language/featured.png"],"datePublished":"2018-09-28T19:12:58Z","dateModified":"2018-09-28T19:12:58Z","author":{"@type":"Person","name":"Denis Trofimov"},"publisher":{"@type":"Organization","name":"Denis Trofimov Blog","logo":{"@type":"ImageObject","url":"https://denis-trofimov.github.io/media/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_192x192_fill_lanczos_center_3.png"}},"description":"\u003cdiv class=\"story-content\"\u003e\n  \u003cp\u003e\n    This post describes how dictionaries are implemented in the Python language.\n  \u003c/p\u003e\n  \u003cp\u003e\n    This article is actually a repost of originally posted at \u003ca href=\"https://www.laurentluce.com/posts/python-dictionary-implementation/\"\u003eLaurent Luce\u0026#8217;s Blog\u003c/a\u003e August 29, 2011 by Laurent Luce. I mentor several students of russian \u003ca href=\"https://learn.python.ru/\"\u003eLearn Python\u003c/a\u003e courses. They have questions about structures in Python and how to use them. I found this post a good help to me and possibly to my students.\n  \u003c/p\u003e\n\u003c/div\u003e"}</script><title>How dictionaries are implemented in the Python language | Denis Trofimov Blog</title></head><body id=top data-spy=scroll data-offset=70 data-target=#TableOfContents class=page-wrapper data-wc-page-id=d5fe5ae0f21fcd5cf5a2ef8eaf2a650b><script src=/js/wowchemy-init.min.ec9d49ca50e4b80bdb08f0417a28ed84.js></script><aside class=search-modal id=search><div class=container><section class=search-header><div class="row no-gutters justify-content-between mb-3"><div class=col-6><h1>Search</h1></div><div class="col-6 col-search-close"><a class=js-search href=# aria-label=Close><i class="fas fa-times-circle text-muted" aria-hidden=true></i></a></div></div><div id=search-box></div></section><section class=section-search-results><div id=search-hits></div></section></div></aside><div class="page-header header--fixed"><header><nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id=navbar-main><div class=container-xl><div class="d-none d-lg-inline-flex"><a class=navbar-brand href=/>Denis Trofimov Blog</a></div><button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar-content aria-controls=navbar-content aria-expanded=false aria-label="Toggle navigation">
<span><i class="fas fa-bars"></i></span></button><div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none"><a class=navbar-brand href=/>Denis Trofimov Blog</a></div><div class="navbar-collapse main-menu-item collapse justify-content-start" id=navbar-content><ul class="navbar-nav d-md-inline-flex"><li class=nav-item><a class=nav-link href=/#about><span>About</span></a></li><li class=nav-item><a class=nav-link href=/#posts><span>Posts</span></a></li><li class=nav-item><a class=nav-link href=/#projects><span>Projects</span></a></li><li class=nav-item><a class=nav-link href=/#contact><span>Contact</span></a></li><li class=nav-item><a class=nav-link href=/uploads/cv-2022.pdf><span>CV</span></a></li></ul></div><ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2"><li class=nav-item><a class="nav-link js-search" href=# aria-label=Search><i class="fas fa-search" aria-hidden=true></i></a></li><li class="nav-item dropdown theme-dropdown"><a href=# class=nav-link data-toggle=dropdown aria-haspopup=true aria-label="Display preferences"><i class="fas fa-moon" aria-hidden=true></i></a><div class=dropdown-menu><a href=# class="dropdown-item js-set-theme-light"><span>Light</span></a>
<a href=# class="dropdown-item js-set-theme-dark"><span>Dark</span></a>
<a href=# class="dropdown-item js-set-theme-auto"><span>Automatic</span></a></div></li></ul></div></nav></header></div><div class=page-body><article class=article><div class="article-container pt-3"><h1>How dictionaries are implemented in the Python language</h1><div class=article-metadata><span class=article-date>Sep 28, 2018</span>
<span class=middot-divider></span>
<span class=article-reading-time>10 min read</span>
<span class=middot-divider></span>
<span class=article-categories><i class="fas fa-folder mr-1"></i><a href=/category/learning/>learning</a></span></div></div><div class="article-header article-container featured-image-wrapper mt-4 mb-4" style=max-width:375px;max-height:311px><div style=position:relative><img src=/how-dictionaries-are-implemented-in-the-python-language/featured_hu2fbd2114a037ca9b00097479cc2911b2_15905_720x2500_fit_q75_h2_lanczos_3.webp width=375 height=311 alt class=featured-image></div></div><div class=article-container><div class=article-style><div class=story-content><p>This post describes how dictionaries are implemented in the Python language.</p><p>This article is actually a repost of originally posted at <a href=https://www.laurentluce.com/posts/python-dictionary-implementation/>Laurent Luce&#8217;s Blog</a> August 29, 2011 by Laurent Luce. I mentor several students of russian <a href=https://learn.python.ru/>Learn Python</a> courses. They have questions about structures in Python and how to use them. I found this post a good help to me and possibly to my students.</p></div><p>Dictionaries are indexed by keys and they can be seen as associative arrays. Let’s add 3 key/value pairs to a dictionary:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>d</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;a&#39;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span> <span class=s1>&#39;b&#39;</span><span class=p>:</span> <span class=mi>2</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>d</span><span class=p>[</span><span class=s1>&#39;c&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>d</span>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=s1>&#39;a&#39;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span> <span class=s1>&#39;b&#39;</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span> <span class=s1>&#39;c&#39;</span><span class=p>:</span> <span class=mi>3</span><span class=p>}</span>
</span></span></code></pre></div><p>The values can be accessed this way:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>d</span><span class=p>[</span><span class=s1>&#39;a&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>d</span><span class=p>[</span><span class=s1>&#39;b&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=mi>2</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>d</span><span class=p>[</span><span class=s1>&#39;c&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>d</span><span class=p>[</span><span class=s1>&#39;d&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>Traceback</span> <span class=p>(</span><span class=n>most</span> <span class=n>recent</span> <span class=n>call</span> <span class=n>last</span><span class=p>):</span>
</span></span><span class=line><span class=cl>  <span class=n>File</span> <span class=s2>&#34;&lt;stdin&gt;&#34;</span><span class=p>,</span> <span class=n>line</span> <span class=mi>1</span><span class=p>,</span> <span class=ow>in</span> <span class=o>&lt;</span><span class=n>module</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=ne>KeyError</span><span class=p>:</span> <span class=s1>&#39;d&#39;</span>
</span></span></code></pre></div><p>The key ‘d’ does not exist so a KeyError exception is raised.</p><h2 id=hash-tables>Hash tables</h2><p>Python dictionaries are implemented using hash tables. It is an array whose indexes are obtained using a hash function on the keys. The goal of a hash function is to distribute the keys evenly in the array. A good hash function minimizes the number of collisions e.g. different keys having the same hash. Python does not have this kind of hash function. Its most important hash functions (for strings and ints) are very regular in common cases:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>map</span><span class=p>(</span><span class=nb>hash</span><span class=p>,</span> <span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>map</span><span class=p>(</span><span class=nb>hash</span><span class=p>,</span> <span class=p>(</span><span class=s2>&#34;namea&#34;</span><span class=p>,</span> <span class=s2>&#34;nameb&#34;</span><span class=p>,</span> <span class=s2>&#34;namec&#34;</span><span class=p>,</span> <span class=s2>&#34;named&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=o>-</span><span class=mi>1658398457</span><span class=p>,</span> <span class=o>-</span><span class=mi>1658398460</span><span class=p>,</span> <span class=o>-</span><span class=mi>1658398459</span><span class=p>,</span> <span class=o>-</span><span class=mi>1658398462</span><span class=p>]</span>
</span></span></code></pre></div><p>We are going to assume that we are using strings as keys for the rest of this post. The hash function for strings in Python is defined as:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=n>arguments</span><span class=p>:</span> <span class=n>string</span> <span class=nb>object</span>
</span></span><span class=line><span class=cl><span class=n>returns</span><span class=p>:</span> <span class=nb>hash</span>
</span></span><span class=line><span class=cl><span class=n>function</span> <span class=n>string_hash</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>hash</span> <span class=n>cached</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>it</span>
</span></span><span class=line><span class=cl>    <span class=nb>set</span> <span class=nb>len</span> <span class=n>to</span> <span class=n>string</span><span class=s1>&#39;s length</span>
</span></span><span class=line><span class=cl>    <span class=n>initialize</span> <span class=n>var</span> <span class=n>p</span> <span class=n>pointing</span> <span class=n>to</span> <span class=mi>1</span><span class=n>st</span> <span class=n>char</span> <span class=n>of</span> <span class=n>string</span> <span class=nb>object</span>
</span></span><span class=line><span class=cl>    <span class=nb>set</span> <span class=n>x</span> <span class=n>to</span> <span class=n>value</span> <span class=n>pointed</span> <span class=n>by</span> <span class=n>p</span> <span class=n>left</span> <span class=n>shifted</span> <span class=n>by</span> <span class=mi>7</span> <span class=n>bits</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=nb>len</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>set</span> <span class=n>var</span> <span class=n>x</span> <span class=n>to</span> <span class=p>(</span><span class=mi>1000003</span> <span class=o>*</span> <span class=n>x</span><span class=p>)</span> <span class=n>xor</span> <span class=n>value</span> <span class=n>pointed</span> <span class=n>by</span> <span class=n>p</span>
</span></span><span class=line><span class=cl>        <span class=n>increment</span> <span class=n>pointer</span> <span class=n>p</span>
</span></span><span class=line><span class=cl>    <span class=nb>set</span> <span class=n>x</span> <span class=n>to</span> <span class=n>x</span> <span class=n>xor</span> <span class=n>length</span> <span class=n>of</span> <span class=n>string</span> <span class=nb>object</span>
</span></span><span class=line><span class=cl>    <span class=n>cache</span> <span class=n>x</span> <span class=k>as</span> <span class=n>the</span> <span class=nb>hash</span> <span class=n>so</span> <span class=n>we</span> <span class=n>don</span><span class=s1>&#39;t need to calculate it again</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>x</span> <span class=k>as</span> <span class=n>the</span> <span class=nb>hash</span>
</span></span></code></pre></div><p>If you run hash(‘a’) in Python, it will execute string_hash() and return 12416037344. Here we assume we are using a 64-bit machine.</p><p>If an array of size x is used to store the key/value pairs then we use a mask equal to x-1 to calculate the slot index of the pair in the array. This makes the computation of the slot index fast. The probability to find an empty slot is high due to the resizing mechanism described below. This means that having a simple computation makes sense in most of the cases. If the size of the array is 8, the index for ‘a’ will be: hash(‘a’) & 7 = 0. The index for ‘b’ is 3, the index for ‘c’ is 2, the index for ‘z’ is 3 which is the same as ‘b’, here we have a collision.</p><p><img class=alignnone src=https://www.laurentluce.com/images/blog/dict/hash.png alt="The hash function for strings in Python for a table size of 8" width=375 height=311></p><p>We can see that the Python hash function does a good job when the keys are consecutive which is good because it is quite common to have this type of data to work with. However, once we add the key ‘z’, there is a collision because it is not consecutive enough.</p><p>We could use a linked list to store the pairs having the same hash but it would increase the lookup time e.g. not O(1) average anymore. The next section describes the collision resolution method used in the case of Python dictionaries.</p><h2>Open addressing</h2><p>Open addressing is a method of collision resolution where probing is used. In case of ‘z’, the slot index 3 is already used in the array so we need to probe for a different index to find one which is not already used. Adding a key/value pair will average O(1) and the lookup operation too.</p><p>A quadratic probing sequence is used to find a free slot. The code is the following:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>j</span> <span class=o>=</span> <span class=p>(</span><span class=mi>5</span><span class=o>*</span><span class=n>j</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span> <span class=o>+</span> <span class=n>perturb</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>perturb</span> <span class=o>&gt;&gt;=</span> <span class=n>PERTURB_SHIFT</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>use</span> <span class=n>j</span> <span class=o>%</span> <span class=mi>2</span><span class=o>**</span><span class=n>i</span> <span class=n>as</span> <span class=n>the</span> <span class=n>next</span> <span class=n>table</span> <span class=n>index</span><span class=p>;</span>
</span></span></code></pre></div><p>Recurring on 5*j+1 quickly magnifies small differences in the bits that didn’t affect the initial index. The variable “perturb” gets the other bits of the hash code into play.</p><p>Just out of curiosity, let’s look at the probing sequence when the table size is 32 and j = 3.<br>3 -> 11 -> 19 -> 29 -> 5 -> 6 -> 16 -> 31 -> 28 -> 13 -> 2…</p><p>You can read more about this probing sequence by looking at the source code of <a href=http://svn.python.org/projects/python/trunk/Objects/dictobject.c>dictobject.c</a>. A detailed explanation of the probing mechanism can be found at the top of the file.</p><p><img src=https://www.laurentluce.com/images/blog/dict/probing.png alt="open addressing"></p><p>Now, let’s look at the Python internal code along with an example.</p><h2>Dictionary C structures</h2><p>The following C structure is used to store a dictionary entry: key/value pair. The hash, key and value are stored. PyObject is the base class of the Python objects.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>Py_ssize_t</span> <span class=n>me_hash</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>PyObject</span> <span class=o>*</span><span class=n>me_key</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>PyObject</span> <span class=o>*</span><span class=n>me_value</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>PyDictEntry</span><span class=p>;</span>
</span></span></code></pre></div><p>The following structure represents a dictionary. ma_fill is the number of used slots + dummy slots. A slot is marked dummy when a key pair is removed. ma_used is the number of used slots (active). ma_mask is equal to the array’s size minus 1 and is used to calculate the slot index. ma_table is the array and ma_smalltable is the initial array of size 8.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=n>_dictobject</span> <span class=n>PyDictObject</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>_dictobject</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>PyObject_HEAD</span>
</span></span><span class=line><span class=cl>    <span class=n>Py_ssize_t</span> <span class=n>ma_fill</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>Py_ssize_t</span> <span class=n>ma_used</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>Py_ssize_t</span> <span class=n>ma_mask</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>PyDictEntry</span> <span class=o>*</span><span class=n>ma_table</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>PyDictEntry</span> <span class=o>*</span><span class=p>(</span><span class=o>*</span><span class=n>ma_lookup</span><span class=p>)(</span><span class=n>PyDictObject</span> <span class=o>*</span><span class=n>mp</span><span class=p>,</span> <span class=n>PyObject</span> <span class=o>*</span><span class=n>key</span><span class=p>,</span> <span class=kt>long</span> <span class=n>hash</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>PyDictEntry</span> <span class=n>ma_smalltable</span><span class=p>[</span><span class=n>PyDict_MINSIZE</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><h2 id=dictionary-initialization>Dictionary initialization</h2><p>When you first create a dictionary, the function PyDict_New() is called. I removed some of the lines and converted the C code to pseudocode to concentrate on the key concepts.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>returns</span> <span class=n>new</span> <span class=n>dictionary</span> <span class=n>object</span>
</span></span><span class=line><span class=cl><span class=n>function</span> <span class=nl>PyDict_New</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>allocate</span> <span class=n>new</span> <span class=n>dictionary</span> <span class=n>object</span>
</span></span><span class=line><span class=cl>    <span class=n>clear</span> <span class=n>dictionary</span><span class=err>&#39;</span><span class=n>s</span> <span class=n>table</span>
</span></span><span class=line><span class=cl>    <span class=n>set</span> <span class=n>dictionary</span><span class=err>&#39;</span><span class=n>s</span> <span class=n>number</span> <span class=n>of</span> <span class=n>used</span> <span class=n>slots</span> <span class=o>+</span> <span class=n>dummy</span> <span class=nf>slots</span> <span class=p>(</span><span class=n>ma_fill</span><span class=p>)</span> <span class=n>to</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>set</span> <span class=n>dictionary</span><span class=err>&#39;</span><span class=n>s</span> <span class=n>number</span> <span class=n>of</span> <span class=n>active</span> <span class=nf>slots</span> <span class=p>(</span><span class=n>ma_used</span><span class=p>)</span> <span class=n>to</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>set</span> <span class=n>dictionary</span><span class=err>&#39;</span><span class=n>s</span> <span class=nf>mask</span> <span class=p>(</span><span class=n>ma_value</span><span class=p>)</span> <span class=n>to</span> <span class=n>dictionary</span> <span class=n>size</span> <span class=o>-</span> <span class=mi>1</span> <span class=o>=</span> <span class=mi>7</span>
</span></span><span class=line><span class=cl>    <span class=n>set</span> <span class=n>dictionary</span><span class=err>&#39;</span><span class=n>s</span> <span class=n>lookup</span> <span class=n>function</span> <span class=n>to</span> <span class=n>lookdict_string</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>allocated</span> <span class=n>dictionary</span> <span class=n>object</span>
</span></span></code></pre></div><h2>Adding items</h2><p>When a new key/value pair is added, PyDict_SetItem() is called. This function takes a pointer to the dictionary object and the key/value pair. It checks if the key is a string and calculates the hash or reuses the one cached if it exists. insertdict() is called to add the new key/value pair and the dictionary is resized if the number of used slots + dummy slots is greater than 2/3 of the array’s size.<br>Why 2/3? It is to make sure the probing sequence can find a free slot fast enough. We will look at the resizing function later.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=n>arguments</span><span class=p>:</span> <span class=n>dictionary</span><span class=p>,</span> <span class=n>key</span><span class=p>,</span> <span class=n>value</span>
</span></span><span class=line><span class=cl><span class=n>returns</span><span class=p>:</span> <span class=mi>0</span> <span class=k>if</span> <span class=n>OK</span> <span class=ow>or</span> <span class=o>-</span><span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=n>function</span> <span class=n>PyDict_SetItem</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>key</span><span class=s1>&#39;s hash cached:</span>
</span></span><span class=line><span class=cl>        <span class=n>use</span> <span class=nb>hash</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>calculate</span> <span class=nb>hash</span>
</span></span><span class=line><span class=cl>    <span class=n>call</span> <span class=n>insertdict</span> <span class=k>with</span> <span class=n>dictionary</span> <span class=nb>object</span><span class=p>,</span> <span class=n>key</span><span class=p>,</span> <span class=nb>hash</span> <span class=ow>and</span> <span class=n>value</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>key</span><span class=o>/</span><span class=n>value</span> <span class=n>pair</span> <span class=n>added</span> <span class=n>successfully</span> <span class=ow>and</span> <span class=n>capacity</span> <span class=n>over</span> <span class=mi>2</span><span class=o>/</span><span class=mi>3</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>call</span> <span class=n>dictresize</span> <span class=n>to</span> <span class=n>resize</span> <span class=n>dictionary</span><span class=s1>&#39;s table</span>
</span></span></code></pre></div><p>inserdict() uses the lookup function lookdict_string() to find a free slot. This is the same function used to find a key. lookdict_string() calculates the slot index using the hash and the mask values. If it cannot find the key in the slot index = hash & mask, it starts probing using the loop described above, until it finds a free slot. At the first probing try, if the key is null, it returns the dummy slot if found during the first lookup. This gives priority to re-use the previously deleted slots.</p><p>We want to add the following key/value pairs: {‘a’: 1, ‘b’: 2′, ‘z’: 26, ‘y’: 25, ‘c’: 5, ‘x’: 24}. This is what happens:</p><p>A dictionary structure is allocated with internal table size of 8.</p><ul><li>PyDict_SetItem: key = &#8216;a&#8217;, value = 1</li><ul><li>hash = hash(&#8216;a&#8217;) = 12416037344</li><li>insertdict</li><ul><li>lookdict_string</li><ul><li>slot index = hash & mask = 12416037344 & 7 = 0</li><li>slot 0 is not used so return it</li></ul><li>init entry at index 0 with key, value and hash</li><li>ma_used = 1, ma_fill = 1</li></ul></ul><li>PyDict_SetItem: key = &#8216;b&#8217;, value = 2</li><ul><li>hash = hash(&#8216;b&#8217;) = 12544037731</li><li>insertdict</li><ul><li>lookdict_string</li><ul><li>slot index = hash & mask = 12544037731 & 7 = 3</li><li>slot 3 is not used so return it</li></ul><li>init entry at index 3 with key, value and hash</li><li>ma_used = 2, ma_fill = 2</li></ul></ul><li>PyDict_SetItem: key = &#8216;z&#8217;, value = 26</li><ul><li>hash = hash(&#8216;z&#8217;) = 15616046971</li><li>insertdict</li><ul><li>lookdict_string</li><ul><li>slot index = hash & mask = 15616046971 & 7 = 3</li><li>slot 3 is used so probe for a different slot: 5 is free</li></ul><li>init entry at index 5 with key, value and hash</li><li>ma_used = 3, ma_fill = 3</li></ul></ul><li>PyDict_SetItem: key = &#8216;y&#8217;, value = 25</li><ul><li>hash = hash(&#8216;y&#8217;) = 15488046584</li><li>insertdict</li><ul><li>lookdict_string</li><ul><li>slot index = hash & mask = 15488046584 & 7 = 0</li><li>slot 0 is used so probe for a different slot: 1 is free</li></ul><li>init entry at index 1 with key, value and hash</li><li>ma_used = 4, ma_fill = 4</li></ul></ul><li>PyDict_SetItem: key = &#8216;c&#8217;, value = 3</li><ul><li>hash = hash(&#8216;c&#8217;) = 12672038114</li><li>insertdict</li><ul><li>lookdict_string</li><ul><li>slot index = hash & mask = 12672038114 & 7 = 2</li><li>slot 2 is free so return it</li></ul><li>init entry at index 2 with key, value and hash</li><li>ma_used = 5, ma_fill = 5</li></ul></ul><li>PyDict_SetItem: key = &#8216;x&#8217;, value = 24</li><ul><li>hash = hash(&#8216;x&#8217;) = 15360046201</li><li>insertdict</li><ul><li>lookdict_string</li><ul><li>slot index = hash & mask = 15360046201 & 7 = 1</li><li>slot 1 is used so probe for a different slot: 7 is free</li></ul><li>init entry at index 7 with key, value and hash</li><li>ma_used = 6, ma_fill = 6</li></ul></ul></ul><p>This is what we have so far:</p><p><img src=https://www.laurentluce.com/images/blog/dict/insert.png alt="python dictionary insert"></p><p>6 slots on 8 are used now so we are over 2/3 of the array’s capacity. dictresize() is called to allocate a larger array. This function also takes care of copying the old table entries to the new table.</p><p>dictresize() is called with minused = 24 in our case which is 4 * ma_used. 2 * ma_used is used when the number of used slots is very large (greater than 50000). Why 4 times the number of used slots? It reduces the number of resize steps and it increases sparseness.</p><p>The new table size needs to be greater than 24 and it is calculated by shifting the current size 1 bit left until it is greater than 24. It ends up being 32 e.g. 8 -> 16 -> 32.</p><p>This is what happens with our table during resizing: a new table of size 32 is allocated. Old table entries are inserted into the new table using the new mask value which is 31. We end up with the following:</p><p><img src=https://www.laurentluce.com/images/blog/dict/resizing.png alt="python dictionary table resizing"></p><h2>Removing items</h2><p>PyDict_DelItem() is called to remove an entry. The hash for this key is calculated and the lookup function is called to return the entry. The slot is now a dummy slot.</p><p>We want to remove the key ‘c’ from our dictionary. We end up with the following array:</p><p><img src=https://www.laurentluce.com/images/blog/dict/delete.png alt="Python dictionary delete key"></p><p>Note that the delete item operation doesn’t trigger an array resize if the number of used slots is much less that the total number of slots. However, when a key/value pair is added, the need for resize is based on the number of used slots + dummy slots so it can shrink the array too.</p><p>That’s it for now. I hope you enjoyed the article. Please write a comment if you have any feedback.</p></div><!--more--><!--more--><div class=metawrap><p>&nbsp;</p><p><em>Originally posted at <a href=https://www.laurentluce.com/posts/python-dictionary-implementation/>Laurent Luce&#8217;s Blog</a> August 29, 2011 by Laurent Luce.</em></p></div></div><div class=article-tags><a class="badge badge-light" href=/tag/algorithms/>algorithms</a>
<a class="badge badge-light" href=/tag/code/>code</a>
<a class="badge badge-light" href=/tag/data-structures/>data structures</a>
<a class="badge badge-light" href=/tag/interview/>interview</a>
<a class="badge badge-light" href=/tag/programming/>programming</a>
<a class="badge badge-light" href=/tag/python/>python</a></div><div class=share-box><ul class=share><li><a href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fdenis-trofimov.github.io%2Fhow-dictionaries-are-implemented-in-the-python-language%2F&amp;text=How+dictionaries+are+implemented+in+the+Python+language" target=_blank rel=noopener class=share-btn-twitter aria-label=twitter><i class="fab fa-twitter"></i></a></li><li><a href="https://www.facebook.com/sharer.php?u=https%3A%2F%2Fdenis-trofimov.github.io%2Fhow-dictionaries-are-implemented-in-the-python-language%2F&amp;t=How+dictionaries+are+implemented+in+the+Python+language" target=_blank rel=noopener class=share-btn-facebook aria-label=facebook><i class="fab fa-facebook"></i></a></li><li><a href="mailto:?subject=How%20dictionaries%20are%20implemented%20in%20the%20Python%20language&amp;body=https%3A%2F%2Fdenis-trofimov.github.io%2Fhow-dictionaries-are-implemented-in-the-python-language%2F" target=_blank rel=noopener class=share-btn-email aria-label=envelope><i class="fas fa-envelope"></i></a></li><li><a href="https://www.linkedin.com/shareArticle?url=https%3A%2F%2Fdenis-trofimov.github.io%2Fhow-dictionaries-are-implemented-in-the-python-language%2F&amp;title=How+dictionaries+are+implemented+in+the+Python+language" target=_blank rel=noopener class=share-btn-linkedin aria-label=linkedin-in><i class="fab fa-linkedin-in"></i></a></li><li><a href="whatsapp://send?text=How+dictionaries+are+implemented+in+the+Python+language%20https%3A%2F%2Fdenis-trofimov.github.io%2Fhow-dictionaries-are-implemented-in-the-python-language%2F" target=_blank rel=noopener class=share-btn-whatsapp aria-label=whatsapp><i class="fab fa-whatsapp"></i></a></li><li><a href="https://service.weibo.com/share/share.php?url=https%3A%2F%2Fdenis-trofimov.github.io%2Fhow-dictionaries-are-implemented-in-the-python-language%2F&amp;title=How+dictionaries+are+implemented+in+the+Python+language" target=_blank rel=noopener class=share-btn-weibo aria-label=weibo><i class="fab fa-weibo"></i></a></li></ul></div><div class="media author-card content-widget-hr"><a href=https://denis-trofimov.github.io/><img class="avatar mr-3 avatar-circle" src=/authors/admin/avatar_hu320604d0f11d38c2cc1c1bb1f611e0db_259689_270x270_fill_q75_lanczos_center.jpg alt="Denis Trofimov"></a><div class=media-body><h5 class=card-title><a href=https://denis-trofimov.github.io/>Denis Trofimov</a></h5><h6 class=card-subtitle>Lead Platform Engineer</h6><p class=card-text>Lead Cloud Platform Developer. I enjoy creating Kubernetes Operators and such :)</p><ul class=network-icon aria-hidden=true><li><a href=https://github.com/denist-huma target=_blank rel=noopener><i class="fab fa-github"></i></a></li><li><a href=https://t.me/DenisTrofimovDev target=_blank rel=noopener><i class="fab fa-telegram"></i></a></li><li><a href=https://www.linkedin.com/in/denis-trofimov-dev/ target=_blank rel=noopener><i class="fab fa-linkedin"></i></a></li><li><a href=https://twitter.com/deniscloudgeek target=_blank rel=noopener><i class="fab fa-twitter"></i></a></li><li><a href=/#contact><i class="fas fa-envelope"></i></a></li><li><a href=/uploads/cv-2022.pdf><i class="ai ai-cv"></i></a></li></ul></div></div></div></article></div><div class=page-footer><div class=container><footer class=site-footer><p class=powered-by><a href=/privacy/>Privacy Policy</a>
&#183;
<a href=/terms/>Terms and Conditions</a></p><p class="powered-by copyright-license-text">© 2025 Me. This work is licensed under <a href=https://creativecommons.org/licenses/by-nc-nd/4.0 rel="noopener noreferrer" target=_blank>CC BY NC ND 4.0</a></p><p class="powered-by footer-license-icons"><a href=https://creativecommons.org/licenses/by-nc-nd/4.0 rel="noopener noreferrer" target=_blank aria-label="Creative Commons"><i class="fab fa-creative-commons fa-2x" aria-hidden=true></i>
<i class="fab fa-creative-commons-by fa-2x" aria-hidden=true></i>
<i class="fab fa-creative-commons-nc fa-2x" aria-hidden=true></i>
<i class="fab fa-creative-commons-nd fa-2x" aria-hidden=true></i></a></p><p class=powered-by>Published with <a href="https://wowchemy.com/?utm_campaign=poweredby" target=_blank rel=noopener>Wowchemy</a> — the free, <a href=https://github.com/wowchemy/wowchemy-hugo-themes target=_blank rel=noopener>open source</a> website builder that empowers creators.</p></footer></div></div><script src=/js/vendor-bundle.min.f64289d8217e08e3afcd597d60836062.js></script>
<script id=search-hit-algolia-template type=text/html><div class=search-hit><div class=search-hit-content><div class=search-hit-name><a href={{relpermalink}}>{{#helpers.highlight}}{ "attribute": "title" }{{/helpers.highlight}}</a></div><div class="article-metadata search-hit-type">{{type}}</div><p class=search-hit-description>{{#helpers.highlight}}{ "attribute": "summary" }{{/helpers.highlight}}</p></div></div></script><script src=https://cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js crossorigin=anonymous></script>
<script src=/en/js/algolia-search-built.min.dac3f31a6538576667a79934060e353c.js type=module></script>
<script id=page-data type=application/json>{"use_headroom":true}</script><script src=/js/wowchemy-headroom.db4755770454eb63685f8de785c0a172.js type=module></script>
<script src=/en/js/wowchemy.min.31ab68bbd55a143f42cc7c744c451560.js></script><div id=modal class="modal fade" role=dialog><div class=modal-dialog><div class=modal-content><div class=modal-header><h5 class=modal-title>Cite</h5><button type=button class=close data-dismiss=modal aria-label=Close>
<span aria-hidden=true>&#215;</span></button></div><div class=modal-body><pre><code></code></pre></div><div class=modal-footer><a class="btn btn-outline-primary my-1 js-copy-cite" href=# target=_blank><i class="fas fa-copy"></i> Copy</a>
<a class="btn btn-outline-primary my-1 js-download-cite" href=# target=_blank><i class="fas fa-download"></i> Download</a><div id=modal-error></div></div></div></div></div><script src=/js/wowchemy-publication.68f8d7090562ca65fc6d3cb3f8f2d2cb.js type=module></script></body></html>